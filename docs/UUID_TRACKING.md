# UUID Tracking for Recipes

## Overview

Each recipe has a **deterministic UUID** generated from its title and source URL. This makes it easy to track recipes through each stage of the ETL pipeline and enables automatic deduplication:

- **Raw Data** - CSV files, Reddit API responses
- **Processing** - Kafka messages, AI parsing
- **Database** - PostgreSQL storage
- **Search Index** - Elasticsearch
- **Client Display** - React UI

## Key Features

### Deterministic Generation

UUIDs are generated using **UUID v5** (namespace-based) from:
- **Recipe Title** (normalized: lowercase, trimmed)
- **Source URL** or **Reddit Post ID**

This means:
- ✅ Same recipe from same source = **Same UUID**
- ✅ Automatic deduplication across pipeline restarts
- ✅ Idempotent processing (reprocessing doesn't create duplicates)
- ✅ Predictable UUIDs for debugging

### Benefits

1. **Automatic Deduplication** - Same recipe from multiple sources gets same UUID
2. **Cross-system Tracking** - Track a recipe from source to display using a single identifier
3. **Idempotency** - Reprocessing same data doesn't create duplicates
4. **Debugging** - Trace issues through the entire pipeline with predictable UUIDs
5. **Logging** - Correlate logs across different services
6. **Database Independence** - UUID remains constant even if database IDs change
7. **Consistency** - UUIDs survive system restarts and reprocessing

## Implementation

### Database Schema

The `recipes` table now includes a `uuid` column:

```sql
uuid UUID UNIQUE NOT NULL DEFAULT gen_random_uuid()
```

- **Type**: PostgreSQL UUID type
- **Default**: Auto-generated using `gen_random_uuid()`
- **Indexed**: For fast lookups
- **Unique**: Enforced at database level

### Recipe Model

The Python `Recipe` model accepts UUIDs (generated by RecipeService):

```python
class Recipe(BaseModel):
    id: Optional[int] = None
    uuid: Optional[str] = None  # Generated deterministically from title + source_url
    title: str
    # ... other fields
```

### UUID Generation

UUIDs are generated using the utility function:

```python
from recipes.utils.uuid_utils import generate_recipe_uuid, generate_reddit_recipe_uuid

# For general recipes
uuid = generate_recipe_uuid("Chocolate Chip Cookies", "https://example.com/recipe1")

# For Reddit recipes
uuid = generate_reddit_recipe_uuid("Chocolate Chip Cookies", "t3_abc123")

# Same inputs = Same UUID (deterministic!)
uuid2 = generate_recipe_uuid("Chocolate Chip Cookies", "https://example.com/recipe1")
assert uuid == uuid2  # True!
```

The `RecipeService.create()` method automatically generates UUIDs:
- For **Reddit recipes**: Uses `reddit:{post_id}` as source
- For **other recipes**: Uses `source_url` if available
- For **recipes without source**: Uses empty string (title only)

### Elasticsearch Index

UUIDs are stored in Elasticsearch for search and filtering:

```json
{
  "uuid": {"type": "keyword"},
  "id": {"type": "integer"},
  "title": {"type": "text"},
  ...
}
```

### Client Display

The React client displays UUIDs in a subtle, monospace format below the recipe title:

```
Recipe Title
UUID: 550e8400-e29b-41d4-a716-446655440000
Recipe ID: 28831
```

## Migration

### Applying the Migration

For existing databases, run the migration script:

```bash
# From project root
./scripts/setup/apply_uuid_migration.sh
```

Or manually:

```bash
psql -U postgres -d recipes -f db/migrations/001_add_recipe_uuid.sql
```

### What the Migration Does

1. Adds `uuid` column to `recipes` table
2. Creates PostgreSQL function `generate_recipe_uuid()` for deterministic UUID generation
3. Creates index on `uuid` for fast lookups
4. Backfills **deterministic** UUIDs for all existing recipes:
   - Reddit recipes: Uses `title + reddit:{post_id}`
   - Recipes with source_url: Uses `title + source_url`
   - Other recipes: Uses `title` only
5. Sets `uuid` column as NOT NULL
6. Displays sample of regenerated UUIDs

### After Migration

1. **Verify UUIDs were generated:**

```bash
psql -U postgres -d recipes -c 'SELECT id, uuid, title FROM recipes LIMIT 5;'
```

2. **Recreate Elasticsearch index with UUID field:**

```bash
python -m recipes.cli sync-search --recreate-index
```

## Usage Examples

### Finding a Recipe by UUID (Python)

```python
from recipes.services.recipe_service import RecipeService

# Search by UUID in database
recipe = await RecipeService.get_by_uuid("550e8400-e29b-41d4-a716-446655440000")
```

### Searching by UUID (Elasticsearch)

```bash
curl -X GET "localhost:9200/recipes/_search" -H 'Content-Type: application/json' -d'
{
  "query": {
    "term": {
      "uuid": "550e8400-e29b-41d4-a716-446655440000"
    }
  }
}
'
```

### Logging with UUID

```python
logger.info(f"Processing recipe {recipe.uuid}: {recipe.title}")
# Output: Processing recipe 550e8400-e29b-41d4-a716-446655440000: Soy Braised Beef
```

## How UUID Generation Works

### Example 1: Reddit Recipe

```python
title = "Soy Braised Beef"
reddit_post_id = "t3_1abc123"

# Generates: generate_recipe_uuid("Soy Braised Beef", "reddit:t3_1abc123")
# Normalized: "soy braised beef:reddit:t3_1abc123"
# UUID: b3d4e5f6-7890-5abc-def0-123456789abc (deterministic!)
```

### Example 2: Recipe with Source URL

```python
title = "Chocolate Chip Cookies"
source_url = "https://example.com/recipes/cookies"

# Generates: generate_recipe_uuid(title, source_url)
# Normalized: "chocolate chip cookies:https://example.com/recipes/cookies"
# UUID: a1b2c3d4-5678-59ef-0123-456789abcdef (deterministic!)
```

### Example 3: Recipe without Source

```python
title = "Grandma's Secret Recipe"
source_url = None

# Generates: generate_recipe_uuid(title, "")
# Normalized: "grandma's secret recipe:"
# UUID: c2d3e4f5-6789-5012-3456-789abcdef012 (deterministic!)
```

## Deduplication in Action

When the same recipe is processed multiple times:

```python
# First processing
recipe1 = Recipe(
    title="Chocolate Chip Cookies",
    source_url="https://example.com/recipe1"
)
await RecipeService.create(recipe1)
# UUID: a1b2c3d4-5678-59ef-0123-456789abcdef

# Later reprocessing (after system restart, etc.)
recipe2 = Recipe(
    title="Chocolate Chip Cookies",
    source_url="https://example.com/recipe1"
)
await RecipeService.create(recipe2)
# UUID: a1b2c3d4-5678-59ef-0123-456789abcdef (SAME!)
# Database UNIQUE constraint prevents duplicate
```

## Best Practices

1. **Always log UUIDs** when processing recipes
2. **UUIDs handle deduplication automatically** - same title+source = same UUID
3. **Include UUIDs in error messages** for easier debugging
4. **Pass UUIDs through Kafka messages** for distributed tracking
5. **Store UUIDs in all intermediate data formats** (JSON, CSV exports, etc.)
6. **Trust the deterministic generation** - don't manually create UUIDs

## Future Enhancements

- Add UUID-based recipe search endpoint
- Include UUID in recipe URLs (`/recipes/{uuid}`)
- Add UUID to recipe exports and backups
- Create UUID-based recipe versioning system
- Track recipe lineage using UUID relationships

